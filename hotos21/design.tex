%-------------------------------------------------------------------------------
\section{Design}
%-------------------------------------------------------------------------------
%\input{design_figs}

\sys's design allows developers to capture exactly which data contents, and which data correlations may be
identity-sensitive. \sys models an application's data as a graph of \emph{entity} nodes and edges.
Each entity type corresponds to an application datatable, such as a users, papers, or reviews table.
Entities are linked in the entity graph by foreign key relationships: table columns that act as
foreign keys to other tables create child-parent relationships between entities, where the child
entity holds the parent entity's identifier as a foreign key. \sys also includes
abstract entities in the graph, where the keys may be non-referential identifiers that refer to
abstract, non-table entities (e.g.,\ a \texttt{thread\_id} column in the comments table).  Edges in
the graph---foreign or abstract key relationships---represent correlations between the nodes of the
graph, namely individual entities.

Unsubscription policies center around the abstraction of \emph{ghost entities}. A ghost entity is
more than an anonymized version of a real entity: a real entity may be replaced by multiple ghost
entities, breaking up correlations associated with the real entity; and ghost entities can be
partially randomized, partially custom generated, and partially clones of the real entities. 
Pre- and post-unsubscription state differ by the presence of ghost entity nodes and edges, which
have taken the place of real entities and edges. \sys returns the real entity data and a mapping
from entities to their ghost replacements back to the unsubscribing user, which, if returned upon
resubscription, allows \sys to restore the user to their original state.

While \sys operates on a specific instance of the application entity graph, the developer reasons
only about the \emph{types} of individual entities and the \emph{types} of entity edges that may be
instantiated in the graph. This allows unsubscription policies to be specified statically using only
the application schema, while \sys ensures that any instance of the application entity graph
satisfies the state specified in the policy.

To exemplify \sys's policy choices, we demonstrate how each choice changes the state of user, paper,
and review entities in a simplified variant of the HotCRP schema, shown in Figure~\ref{fig:schema}.

\subsection{Generating Ghost Entities}
\label{sec:ghosting}

\sys generates ghost entities in order to break correlations between child and parent entities.  A
ghost entity adopts one or more children of a real entity, removing the potentially identifying
correlation: for example, a different ghost user can adopt each of a user's reviews, thus
decorrelating any links between reviews and the user. \sys produces one or more ghosts for every
template real entity that is ghosted. 

In order for \sys to generate ghost entities, developers must define ghost generation policies for
each entity type.  \sys assumes entities have three kinds of attributes: a unique identifier
attribute; value (non-referential) attributes such as timestamps or usernames; and edge (referential
foreign key) attributes that identify correlations to parent entities.  Value attributes may
directly expose identifying information from its contents, and edge attributes represent potentially
sensitive structural correlations.  Developers specify how \sys should generate each of these
attributes, given a template real entity.

\sys always generates ghost entities with unique identifier attribute values.

For each value and edge attribute of each entity type, developers specify a \emph{ghosting policy}.
The developer chooses one of the following ghosting policies, which take as input a template
entity's attribute value:
\begin{itemize}
    \item \textbf{Clone-All:} All ghosts generated from the same template share the template's 
        attribute value. For edge attributes, this means that all ghosts generated will share the
        same edge to a parent entity.

    \item \textbf{Generate-All:} 
        For value attributes, developers specify whether the ghost attribute value should be
        random, a default value, or generated from the template value via a custom function.
        
        For edge attributes, \sys generates a new parent ghost entity, and uses the parent ghost
        identifier as the edge attribute value.

    \item \textbf{Clone-One:} One ghost entity shares the same value for the attribute as the
        template. 
        
        For value attributes, developers specify whether the rest of the ghosts' attribute value should be
        random, a default value, or generated from the template value via a custom function.

        For edge attributes, \sys generates a new parent ghost entity for each of the remaining
        ghosts, and uses the parent ghost identifier as the attribute value.
\end{itemize}
Clone policies enable the application to retain the original template entity data by cloning the value
of the template entity. For example, HotCRP may want to generate ghost users that clone 
the value attribute indicating whether the user account is disabled or enabled. To keep application
metadata consistent, HotCRP may want to ensure that one ghost user generated from the real user
clones the user's roles, while assigning all other ghosts no roles.

%Figure~\ref{fig:example} demonstrates examples of these various policies on a range of
%value attributes.

%Figure~\ref{fig:policy} shows pseudocode for \sys's policy specification types.

%Using ghost generation policies, \sys creates ghost entities to replace unsubscribed entities. 

%During unsubscription, \sys traverses the current instance of the application entity graph with the
%top-level unsubscribing user node as the root in order to find all possible graph edges and nodes
%that may be sensitive. \sys then applies the applies the appropriate decorrelation policy to all
%sensitive edges depending on the edge type, generating ghost nodes with ghosted attributes to
%replace real nodes as specified.
%
%After ghosts are generated from the template entity, \sys returns a copy of the template entity to
%the unsubscribing user, which if returned upon resubscription, allows \sys to restore the original
%value. If the user does not wish to store this data, resubscription retains the ghosted value in
%%place of the original.
%Resubscription requires the user to return the original
%data to restore the original value.

\subsection{Edge Policies}
While ghost generation policies inform \sys how to produce ghosts, developers must also specify
\emph{when} \sys should produce ghosts. 
The developer provides \sys this information in the form of edge policies, one per edge type (a pair of parent
entity type and child entity type). 
%Figure~\ref{fig:example} shows three different
%child-parent edge types: stories-users, votes-users, and votes-stories.
Developers specify a
\emph{sensitivity threshold} that tells \sys to partially (or fully) decorrelate or remove edges,
retaining up to the threshold fraction of existing correlations.
Developers can choose whether \sys decorrelates edges of this type, splitting a single parent
into one ghost parent per edge, or simply removes these edges. 
The following sections explain edge policies in more detail.

\lyt{TODO Figure~\ref{fig:edge_policies} depicts how the state of stories-users edge types changes depending
on the policy.}

\paragraph{What is the Sensitivity Threshold?}
For each edge policy, the developer specifies a \emph{sensitivity
threshold $\sigma$}; if no threshold is specified, \sys defaults to $\sigma=0$. 

The sensitivity threshold determines the maximum proportion of edge instances (of the policy's edge
type) from a real parent entity that may remain correlated to \emph{sensitive} child entities (i.e.,\
entities transitively correlated to the initial entity being unsubscribed). 

At a high level, the sensitivity threshold estimates how much identifying information may leak from
edge instances of that type. Developers can determine an appropriate sensitivity threshold for each
edge type by approximating how much identifying information may be leaked if edges of this type with
the same parent \emph{all} correlate (even indirectly) back to the entity being unsubscribed. In
other words, what happens if all children of edges of this type (with the same parent) are
sensitive?

For example, consider the edge from papers to tags. If all the papers tagged with the same parent
tag in the entity graph belonged to by some (unsubscribed) user, would the paper-tag correlation be
problematic? The answer may be yes: perhaps tags are customizable by the user, and any paper with
that tag will clearly belong to the unsubscribed user. In other cases, the answer may be no: even
though the tag is only correlated with sensitive papers, the tag indicates nothing about who may
have authored the papers.

For many cases, the answer may lie somewhere in the middle: it is problematic if \emph{all} of
children of edge of this type are sensitive, but perhaps it is acceptable if only a fraction of
children of this edge type are sensitive. The maximum acceptable fraction is the sensitivity
threshold. For example, a reasonable sensitivity threshold might be $\sigma = 0.1$ for paper-tag
key relationships: less than 10\% of all paper with a specific tag key should have been correlated
(even indirectly) with an (unsubscribed) user. 

%\textbf{Add ghost correlations}: For each parent of this edge type, \sys
%generates ghost children ntities using the appropriate value ghosting policies and an
%existing child entity as a template. All ghost children point to the parent (share the
%same edge attribute value).  \sys generates enough ghost children that the sensitivity
%threshold is met.  Note that if the generated ghosts are easily distinguished from
%actual entities, there is little privacy benefit from generating ghost entities to meet
%the threshold.

\paragraph{Achieving the Sensitivity Threshold.}
The developer chooses between two options to achieve the sensitivity threshold: 
\begin{enumerate}
    \item \textbf{Decorrelate.}
    \sys decorrelates edges from the parent entity to its children by 
    replacing edges with ones to a unique ghost parent, generated using the
    real parent as a template. \sys relinks the child to a unique ghost by replacing the child's edge
    attribute (foreign key column) with a unique ghost parent's identifier. 

\item \textbf{Delete.}
    \sys deletes the edge by removing the child entity and any descendants. Developers should select
    this edge policy option only if this type of edge cannot be decorrelated while retaining application
    semantics, but retaining edges to a shared parent would reveal too much identifying information.
\end{enumerate}

For each parent, \sys decorrelates or deletes edges to children only enough to achieve the specified
threshold, and retains the remaining edges. Note that if all children are sensitive (a user's papers
are always sensitive), or if the sensitivity threshold is 0, \sys will decorrelate or delete all
children. 

On the other hand, if the developer specifies a sensitivity threshold of 1, \sys retains all
correlations between children and the parent. Developers should select this option only if the
developer knows that these correlations cannot collectively leak identifying information, and/or if
the application's functionality would be impacted by deleting or decorrelating this type of edge.

If \sys retains any edges from children to the parent, \sys generates a single ghost parent entity using the
parent as a template. The ghost parent adopts all children that remained correlated with the real
parent by replacing the childrens' edge attribute with the ghost's identifier.

\paragraph{Returning User Data.}
After applying the appropriate edge policies, \sys returns all 
removed entity data back to the unsubscribing user. \sys also deletes and returns all parent entities that
have been replaced by ghosts (when edges are retained or decorrelated).

\sys additionally returns the identifier attributes of all generated ghosts, and a mapping from real
entity to the set of ghosts that replaced that entity's correlations. 

\subsection{Resubscription}
Upon resubscription, the user returns any ghost mappings and any removed entity data they received
upon unsubscribing, allowing \sys to remove any created ghost entities, recorrelate entities back
with the correct real entity, and restore removed entities and their descendants. 

\sys allows the application developer or user to ignore any entity data returned by \sys upon
unsubscription, but consequently cannot restore this data when the user resubscribes.  This choice
reduces the amount of user-side storage required for resubscription when the data can be easily
re-initialized, is simply too large to store, or plays no essential role in using the application.

\subsection{\sys's Execution Algorithm}
Given an application's schema and unsubscription policy, and an entity to be decorrelated as input,
\sys executes unsubscription as follows:
\begin{enumerate}
    \item \textbf{Parent-Child Traversal:} \sys traverses the entity graph starting from the input entity,
        going down parent to child edges (and halting if it detects a cycle).  As it traverses,
        \sys collects the edges it has traversed. 
    
    \item \textbf{Parent-Child Edge Policy Application:} 
        Post-traversal, \sys acts on each collected edge instance according to the specified
        decorrelation relationship policy for that edge's type.

        Given every unique parent entity, \sys applies policies as appropriate to the parent's edges
        to children. Any edges that should be deleted removes the child entity and any descendants.
        \sys generates new ghost parents using the real parent as template for any edges that should
        be decorrelated, and rewrites the child's edge attribute to be the ghost parent's
        identifier. If any edges are retained, \sys generates a ghost parent entity to replace the 
        For every unique parent entity, \sys 

        If edges can be decorrelated, \sys generates ghost parent entities and new edges between
        child and ghost parent entities using the appropriate ghost entity generation policy. If
        edges cannot be decorrelated and should be retained or deleted, \sys does nothing or removes
        the child and edge respectively. 
    
        If there is a sensitivity threshold for the edge's type, \sys ensures the
        sensitivity of the edge is below $t$'s threshold, providing the edge type and the edge's
        parent key to the procedure described in Section~\ref{sensitivity_algo}. 

    \item \textbf{Child-Parent Decorrelation:} Next, \sys takes the children of all traversed edge
        instances, and considers the set of edges from these children to other parents
        \emph{not} traversed by \sys during the decorrelation phase. (In other words, these
        children entities have multiple key relationships to several parent entities, one of
        which is connected via a chain of parent-child edges to the input entity).

        Intuitively, children of edges traversed by \sys share a connection with the initial
        entity being decorrelated. Edges \emph{from} these children to other parent entities may
        thus leak sensitive identifying information. 

        \sys acts on these edges according to the specified decorrelation relationship policy for
        each edge's type. If these edges can be decorrelated, \sys generates ghost parent entities
        for each sensitive child.  If these edges cannot be decorrelated and should be retained or
        deleted, \sys does nothing or removes the child and edge respectively. 
        
        Otherwise, if there is a sensitivity threshold for the edge type, then \sys limits the
        proportion of edges of that type that connect to sensitive entities (the children of
        traversed edge instances) to below the threshold. 
        For each edge with type $t$ in this set of edges, \sys ensures the
        sensitivity of the edge is below $t$'s sensitivity threshold, providing the edge type and the edge's
        parent key to the procedure described in Section~\ref{sensitivity_algo}. 

        \sys optionally allows developers to specify that edges have \emph{weaker}
        decorrelation policies in the child-to-parent direction than from parent-to-child: this
        allows expression of policies where it is safe to retain links if \emph{only the child} is
        sensitive, but where the link should be decorrelated, removed, or desensitized if
        \emph{both} the child
        and parent are sensitive. For example, perhaps a user wants to ensure that their link to
        sent messages are decorrelated, but links from the message to the recipient users 
        can still be retained.
\end{enumerate}

An example of these three decorrelation steps is shown in Figure~\ref{fig:algo}.

\subsubsection{Achieving the Sensitivity Threshold}
\label{sensitivity_algo}
Let $E$ be the subset of edges traversed by \sys in Step 1 of execution. 
Given an edge type $t$ with sensitivity threshold $\sigma_t$, and a parent key $k$ of an instance of
edge type $t$, 
    \begin{itemize}
        \item \sys computes $N_{sensitive}$, the number of edges of type $t$ with parent $k$ in the entity graph that share 
            a child node with edges in $E$.
        \item \sys computes $N_{all}$, the total number of edges of type $t$ with parent $k$
            in the entity graph of edge.
        \item \sys computes $N_{sensitive}/N_{all}$, the \emph{sensitivity} of edges of type $t$
            with parent $k$.
        \item If the sensitivity exceeds $\sigma_t$ and the child entity type has an associated ghost entity policy, \sys
            generates ghost children and edges of type $t$ from these children to parent
            key $k$. This lowers the sensitivity by increasing $N_{all}$. Note that this may also
            create other ghost parents for the generated ghost children if these children have more
            than one column representing a foreign key relationship.
        \item Otherwise, if the sensitivity exceeds $\sigma_t$ but ghosts cannot be generated,
            \sys removes the children of edges in $E_t$ with parent $k$, thus lowering the
            sensitivity by lowering $N_{sensitive}$.
    \end{itemize}

Note that the initial sensitivity for an edge of type $t$ with parent $k$ from Step 2 (parent-child
decorrelation) is always 1. Because \sys traverses from parent to child, if one edge of type $t$ with
parent $k$ were collected by \sys, then \emph{all} edges of type $t$ with parent $k$ were collected
by \sys. 

However, the initial sensitivity for an edge of type $t$ with parent $k$ from Step 3 (child-parent
decorrelation) may be very low: other parents of children touched by \sys may have many
non-sensitive children (e.g.,\ a tag may have many stories not authored by the user being
decorrelated).

\begin{figure}[t!]
    \includegraphics[width=.5\textwidth]{img/algo}
    \label{fig:algo}
    \caption{Examples of \sys's execution.}
\end{figure}

%\paragraph{Example policy.}
%We can imagine an application tin which only the sum of votes per story is ever queried by the application; clusters of
%votes around stories can therefore remain without leaking identifying information, and are thus
%assigned Policy 1, ``Do Not Decorrelate (Retain)''. 
%Decorrelation does propagate to the votes themselves, which are clustered by a \texttt{location} attribute; 
%this cluster by location can have a different decorrelation policy that generates ghost locations by
%randomizing the location, breaking up the cluster. 
%

%\sys provides a menu of unsubscription policy choices that allow developers to choose how to
%\emph{ghost} individual data record content, and how to \emph{decorrelate} sensitive correlations. 
%Specifying the policy requires nothing more than the application schema: ghosting policies act on
%application datatables and on foreign key relationships between tables.
%Table column values can be ghosted---removed, anonymized, or modified---in application-specific
%ways; and correlations can be broken, removed, or desensitized by adding noise. This gives
%developers the flexibility to specify fine-grained policies that properly de-identify a user, while
%retaining data as necessary for the application.

%\sys must pinpoint exactly which data and correlations may be
%identity-sensitive, and allow developers to specify exactly what the post-unsubscription state of
%this data should be.

