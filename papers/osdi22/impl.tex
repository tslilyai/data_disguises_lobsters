%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Implementing Disguising}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{table*}[t!]
\centering
\begin{tabular}{ c p{.7\linewidth} }
\textbf{Function} & \textbf{Description} \\
\hline
    \fn{ReadPrivateTokens(\symk{p\delta})} & Decrypts all of $p$'s private tokens produced by disguise
    $d$ using \symk{p\delta}. \\
    \fn{ReadGlobalTokens($d$)} & Retrieves all global tokens produced by disguise $d$. \\
    \fn{ApplyDisguise($d$,tokens)} & Applies disguise $d$, selectively composing $d$'s
    updates with prior disguises using the tokens's data. \\
    \fn{\op{d}.execute(tokens)} & Executes the disguise operation \op{d}, composing the operation
    with prior disguises using the tokens' data.\\
    \fn{ReverseDisguise($d$,tokens)} & Reverses disguise $d$ using the tokens' data.\\
    \fn{ReverseTokenOp(token)} & Reverses the data modification performed by the disguise operation
    that produced the token.\\
    \fn{StorePubKey($\pubk{p}$)} & Persistently saves the public key \pubk{p} indexed by $p$.\\
    \fn{LoadPubKey($p$)} & Retrieves public key \pubk{p} for $p$.\\
    \fn{LoadEncPrivKeyTokens($p$)} & Retrieves \tpriv{pdq'} ciphertexts for $p$.\\
    \fn{LoadEncSymKeys(caps)} & Retrieves \symk{p\delta} ciphertexts corresponding to the specified
    capabilities.\\
    \fn{StoreEncSymKey(\capa{p\delta})} & Persistently saves the \symk{p\delta} ciphertext indexed by
    capability \capa{p\delta}.\\
    \fn{LoadListTail}$(p,d)$ & Gets the first encrypted private token in \tokls{p\delta}, the list of
    tokens associated with $p$ produced by $d$.\\
    \fn{StoreListTail}$(p,d)$ & Persistently saves the first encrypted private token in \tokls{p\delta}
    indexed by $p$ and $d$.
\end{tabular}
    \vspace{12px}
\caption{Internal \sys functions}
\label{tab:funcs}
\end{table*}

Table~\ref{tab:funcs} describe \sys's internal functions run server-side to implement its API 
and apply or reverse disguises. 

Figures~\ref{fig:appdisg} and \ref{fig:revdisg} describe how \sys implements disguise application and
reversal respectively. Figure~\ref{fig:opexec} describes how disguise operations update application
state and produce and modify tokens, and 
Figure~\ref{fig:revtoken} describes how \sys uses a token's recorded
modification to reverse an applied disguise operation. 
Figure~\ref{fig:rpt} describes how \sys accesses the private tokens
corresponding to disguise $d$ and principal $p$ by recursively decrypting tokens and traversing
\tokls{p\delta}.

\sys's implementations of the remaining functions in Table~\ref{tab:funcs} simply read or write into
persistent maps indexed by principal and/or disguise.
