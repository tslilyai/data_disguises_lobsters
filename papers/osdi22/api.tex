\begin{figure}[t]
%\centering
%    \begin{tabular}{ p{.5\linewidth} p{.5\linewidth} }
%\textbf{API Call} & \textbf{Description} \\
%\hline
%    \fn{ApplyDisguise($p$, $d$, DisguiseSpec dSpec, \privk{p}, \{\lcapa{pd'}\})}
%        $\rightarrow$ (\lcapa{pd}, \lcapa{pd}) &
%        Applies disguise $d$, returning a parit of locators required to later locate disguise $d$'s
%        diff and speaks-for records respectively.
%        \vspace{6pt}\\
%        \fn{RevealDisguise($p$, $d$, \privk{p}, \lcapa{pd})} $\rightarrow$ ()&
%        Reveals disguise $d$ by reversing data stored in records produced by disguise $d$ accessible
%        using \lcapa{pd} and \privk{p}.
%        \lyt{In practice this takes a set of \lcapa{} from different disguises because of
%        pseudoprincipals}
%\end{tabular}
\begin{lstlisting}[style=rust,escapeinside={(*}{*)}]
(*\textbf{RegisterPrincipal}*)(p: UID, pubk: PubKey);
// Applies disguise to principal p, optionally
// over already-disguised data for compose_on ((*\S\ref{s:composition}*))
(*\textbf{ApplyDisguise}*)(p: UID, spec: DisguiseSpec,
    compose_on: Option<(PrivKey, Vec<Locator>)>)
    -> (DisguiseID, Vec<Locator>);
// Reveals did for p, using p's private key. locs
// are bags p can decrypt (possibly via pseudop.).
(*\textbf{RevealDisguise}*)(p: UID, did: DisguiseID, privk: PrivKey, locs: Vec<Locator>);
\end{lstlisting}
\caption{\sys's high-level API (Rust-like syntax).}
\label{f:api-high}
\end{figure}

\begin{figure}[t]
%\centering
%    \begin{tabular}{ p{.5\linewidth} p{.5\linewidth} }
%\textbf{API Call} & \textbf{Description} \\
%\hline
%\fn{RegisterPrincipal($p$)} $\rightarrow$ \privk{p} & Registers $p$ as
%        a principal, returning a private key \privk{p} corresponding to a principal-specific public
%        key $\pubk{p}$ known to \sys.\\
%    \vspace{6pt}\\
%\fn{StartDisguise($d$) $\rightarrow$ ()} & Invoked to inform \sys that a disguise application is
%        starting.
%    \vspace{6pt}\\
%        \fn{EndDisguise($d$) $\rightarrow$ (\lcapa{pd}, \lcapa{pd})} & Marks the end of applying disguise $d$.
%        Returns a pair of locators required to later locate disguise $d$'s diff records and
%        speakds-for records
%        respectively.
%    \vspace{6pt}\\
%        \fn{SaveDiffRecord($p$, $d$, recordData)} $\rightarrow$ () & Securely stores recordData in a diff record \tdiff{pd}.\\
%    \vspace{6pt}\\
%        \fn{SaveSpeaksForRecord($p$, $p'$, $d$, recordData)} $\rightarrow$ () & Securely stores recordData in a
%        speaks-for record \town{pd} that saves the link from principal $p$ to pseudoprincipal $p'$.\\
%    \vspace{6pt}\\
%        \fn{CreatePseudoprincipal()} $\rightarrow$ ($p$, \fn{principalData}) & Returns
%        the pseudoprincipal ID and data of a new pseudoprincipal. \fn{principalData} is
%        generated using an application-specified pseudoprincipal-generation policy.\\
%    \vspace{6pt}\\
%        \fn{GetRecordsOfDisguise($d$, \privk{p}, \lcapa{pd})}
%        $\rightarrow$ (\{\tdiff{pd}\}, \{\town{pd}\}) & Retrieves the diff and speaks-for records produced by
%        disguise $d$ that are accessible with the provided locator
%        and decryption capability.
%    \vspace{6pt}\\
%        \fn{GetPseudoprincipalsOf($p$, \privk{p}, \{\lcapa{pd}\})} $\rightarrow$ \{$p'$\} & Returns
%        the pseudoprincipal IDs of all pseudoprincipals linked with $p$ produced by disguises $d$.
%        The decryption capability and set of locators enable \sys to access speaks-for records that
%        reveal links between $p$ and its pseudoprincipals.\\
%    \end{tabular}
\begin{lstlisting}[style=rust,escapeinside={(*}{*)}]
// Principal operations.
(*\textbf{RegisterPrincipal}*)(p: UID, pubk: PubKey);
(*\textbf{RegisterPseudoprincipal}*)(pp: UID);
(*\textbf{ForgetPrincipal}*)(p: UID);

// Starts a new disguise, returns disguise ID.
(*\textbf{StartDisguise}*)() -> DisguiseID;
// During active disguise, encrypts & stores diff
// with app-provided content for principal ownerP.
(*\textbf{StoreDiff}*)(ownerP: UID, buffer: Vec<u8>,
         remember_loc_on_compose: bool);
// During active disguise, encrypts and stores
// mapping that oldP speaks for newP.
(*\textbf{StoreSpeaksFor}*)(oldP: UID, newP: UID,
             remember_loc_on_compose: bool);
// Finishes disguise, returns accumulated locators
(*\textbf{EndDisguise}*)(did: DisguiseID) -> Vec<Locator>;

// Obtains diffs at loc stored by disguise did.
(*\textbf{DiffsForDisguise}*)(did: DisguiseID, privk: PrivKey,
               loc: Locator) -> Vec<Vec<u8>>;
// Gets principals at loc that p speaks for.
(*\textbf{PseudoprincipalsOf}*)(p: UID, privk: PrivKey,
                 loc: Locator) -> Vec<UID>;
// Drops encrypted data stored by did at loc.
(*\textbf{ForgetData}*)(did: DisguiseID, loc: Locator);
\end{lstlisting}
\caption{\sys's low-level API (Rust-like syntax).}
\label{f:api-low}
\end{figure}


