%-------------------------------------------------------------------------------
\section{Overview and API}
\label{s:api}
%-------------------------------------------------------------------------------
\input{tables}

\sys exposes an API (Table~\ref{tab:api}) to web applications that wish to support secure
disguising.
%
The API allows the application to start and end disguises; save diff token data 
and pseud
The application also uses \sys to access and interpret diffs authorized by the provided
capabilities.  Applications integrating with \sys may modify the client API
so that the client can pass capabilities to the application along with the action to perform.
For example, the application can send users URLs to click that invoke application actions with
capability arguments.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We next describe example usages of the API.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{Principal Registration.}
Every client who creates an application account for principal $p$ registers an email and public key with \sys.
\sys remembers each public key \pubk{p} along with $p$'s ID.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{Disguising and Revealing.}
When a client speaking for principal $p$ wants to apply a disguise $d$,
the application invokes \fn{ApplyDisguise} with the client-provided data
capability and a set of  capabilities. Each locator \lcapa{pd'} allows \sys to
access $p$'s disguise diffs from disguise $d'$, and to compose the new disguise on top of these
disguises during application. Applying a disguise returns the  capability \lcapa{pd} that
the application sends to the client (via e.g., emailing the client a link).

In order to reveal data disguised by $d$ for principal $p$, the application invokes
\fn{RevealDisguise} on behalf of a client speaking for $p$. The client provides its decryption capability
\privk{p} and locator \lcapa{pd}. The application passes these to \sys to restore the
original, undisguised data with access to $p$'s diffs corresponding to $d$.

%\lyt{(ignore this) Why might we need multiple  capabilities for reveal? This is because diffs may change
%other diffs. But in this case, why don't we have the diff storing the diff change also store the
%location of the diff? Also this might only affect "global" diffs.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{Performing Permitted Application Actions.}
Imagine that HotCRP disguise $d$ anonymizes all reviewers and authors of a conference by
decorrelating them from their papers and reviews respectively. As described above, HotCRP emails the
client a link when that their data has been decorrelated, which contains the 
capability in the URL. Assume that HotCRP sends a unique link for every piece of data (\eg every review
or paper); HotCRP could also send a single link for all decorrelated data.

The application normally ensures that only a client speaking for $p$ should have read-only access to
reviews for $p$'s authored papers, and read-write access to reviews $p$ wrote.

If the client speaking for $p$ wants to edit a review as it would normally, the application
(post-$d)$ will not grant the client any read/write permissions to perform actions on any reviews of
the conference: any previously correlated paper or review is now associated with pseudoprincipal
$q$.  

Instead, for the client speaking for $p$ to regain authorship or reviewership permissions of a
particular review or paper:
\begin{itemize}
    \item The client clicks on the URL emailed to the client for that piece of data when it was decorrelated, which
        opens a HotCRP page.
    \item Javascript on the webpage retrieves the client's data capability
        stored by the client's browser, and extracts the  capability and the data object the client
        wants to access from the URL.
    \item The client then must log into HotCRP as principal $p$.
    \item HotCRP invokes \sys's \fn{CapEstablishesOwnership} for the data object in question,
        using the capabilities passed in by the client.
    \item If \sys returns \fn{true}, the application permits the client to view the object with ownership
        rights (\eg ability to see reviews on authored papers, or edit their review); otherwise, the
        application does not allow the client to perform privileged actions.
\end{itemize}


